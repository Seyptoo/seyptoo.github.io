---
title: "HackTheBox - Arkham"
description: test.png
tags: ["Dans cet article je vous présente comment être administrateur dans la boîte Arkham, une boîte assez sympatique, il y'avais une faille Active Directory dans le système pour être administrateur."]
---

Informations
----
    Ip : 10.10.10.130   Created by : MinatoTW
    Level : Medium      Base points : 30
    
Résumé : <br/>


Le système Arkham, disponible sur la platforme [HackTheBox](https://www.hackthebox.eu/), fut très intéressant et amusante. Le niveau de difficulté était plutôt élevée, étant donné qu’une bonne énumération était amplement suffisante. De plus, j’ai appris beaucoup de chose tout au long de l’exploitation des failles de ce système. <br />

- Il y'a le service `SMB` ouvert et nous avons les droits d'accès lecture dans le dossier `BatShare`. <br /><br />
- Dans le dossier `BatShare` il y'avait un fichier `ZIP` comme nom `appserver.zip` et contenait un fichier `backup.img`. <br /><br />
- C'était un fichier de type `LUKS` chiffré, une fois déchiffré avec hashcat nous avons accès à un système de fichier, ou il y'avait des fichiers de configurations de tomcat. <br /><br />
- Un fichier XML particulièrement sensible qui nous permettaient de voir l'algorithme utilisé et le secret pour déchiffrer le `ViewState`. <br /><br />
- Dans le système il y'avait une faille `Java Deserialisation`, ce qui nous permettaient d'éxecuter des commandes à distance sur le système. <br /><br />
- Une fois le reverse shell effectué, dans le dossier d'`Alfred` il y'avait un fichier backup.zip, et contenant un fichier `OST`, une fois ce fichier déchiffré nous avons pu accéder à l'utilisateur `Batman`. <br/><br />
- L'utilisateur Batman fesait partie du groupe `Administrators` dans le service `Active Directory`, et il y'avait une faille `UAC` pour justement créé un disque en tant que administrateur.

Nmap Scan
----

D'après le scan nous avons des services, le `HTTP` qui tourne sur `IIS` sur le port `80`, le `NETBIOS` également qui tourne dans le `135`, le service `SMB` qui tourne dans `139/445`. Et enfin le service qui tourne en `8080`.

    PORT     STATE SERVICE       VERSION
    80/tcp   open  http          Microsoft IIS httpd 10.0
    | http-methods: 
    |   Supported Methods: OPTIONS TRACE GET HEAD POST
    |_  Potentially risky methods: TRACE
    |_http-server-header: Microsoft-IIS/10.0
    |_http-title: IIS Windows Server
    135/tcp  open  msrpc         Microsoft Windows RPC
    139/tcp  open  netbios-ssn   Microsoft Windows 98 netbios-ssn
    445/tcp  open  microsoft-ds?
    8080/tcp open  http-proxy
    | http-methods: 
    |   Supported Methods: GET HEAD POST PUT DELETE OPTIONS
    |_  Potentially risky methods: PUT DELETE
    |_http-open-proxy: Proxy might be redirecting requests
    |_http-title: Mask Inc.
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port8080-TCP:V=7.01%I=7%D=6/17%Time=5D07DD75%P=x86_64-pc-linux-gnu%r(Ge
    SF:tRequest,2D52,"HTTP/1\.1\x20200\x20\r\nAccept-Ranges:\x20bytes\r\nETag:
    SF:\x20W/\"11382-1545655294000\"\r\nLast-Modified:\x20Mon,\x2024\x20Dec\x2
    SF:02018\x2012:41:34\x20GMT\r\nContent-Type:\x20text/html\r\nContent-Lengt
    SF:h:\x2011382\r\nDate:\x20Mon,\x2017\x20Jun\x202019\x2018:35:31\x20GMT\r\
    SF:nConnection:\x20close\r\n\r\n<!DOCTYPE\x20html>\r\n<html>\r\n<head>\r\n
    SF:\t<meta\x20charset=\"utf-8\">\r\n\t<meta\x20name=\"viewport\"\x20conten
    SF:t=\"width=device-width,\x20initial-scale=1\.0\">\r\n\t<title>Mask\x20In
    SF:c\.</title>\r\n\t<meta\x20name=\"description\"\x20content=\"A\x20free\x
    SF:20responsive\x20website\x20template\x20made\x20exclusively\x20for\x20Fr
    SF:ittt\x20by\x20Themesforce\x20and\x20Sarfraz\x20Shaukat\">\r\n\t<meta\x2
    SF:0name=\"keywords\"\x20content=\"website\x20template,\x20css3,\x20one\x2
    SF:0page,\x20bootstrap,\x20app\x20template,\x20web\x20app,\x20start-up\">\
    SF:r\n\t<meta\x20name=\"author\"\x20content=\"Themesforce\x20and\x20Sarfra
    SF:z\x20Shaukat\x20for\x20Frittt\">\r\n\t<link\x20rel=\"icon\"\x20type=\"i
    SF:mage/png\"\x20href=\"favicons/favicon-16x16\.png\"\x20sizes=\"16x16\">\
    SF:r\n\t<link\x20rel=\"stylesheet\"\x20href=\"css/bootstrap\.css\">\r\n\t<
    SF:link\x20rel=\"stylesheet\"\x20href=\"fonts/font-awesome-4\.3\.0/css/fon
    SF:")%r(HTTPOptions,8A,"HTTP/1\.1\x20200\x20\r\nAllow:\x20GET,\x20HEAD,\x2
    SF:0POST,\x20PUT,\x20DELETE,\x20OPTIONS\r\nContent-Length:\x200\r\nDate:\x
    SF:20Mon,\x2017\x20Jun\x202019\x2018:35:32\x20GMT\r\nConnection:\x20close\
    SF:r\n\r\n")%r(RTSPRequest,6A,"HTTP/1\.1\x20400\x20\r\nTransfer-Encoding:\
    SF:x20chunked\r\nDate:\x20Mon,\x2017\x20Jun\x202019\x2018:35:32\x20GMT\r\n
    SF:Connection:\x20close\r\n\r\n0\r\n\r\n")%r(FourOhFourRequest,4F5,"HTTP/1
    SF:\.1\x20404\x20\r\nContent-Type:\x20text/html;charset=utf-8\r\nContent-L
    SF:anguage:\x20en\r\nContent-Length:\x201113\r\nDate:\x20Mon,\x2017\x20Jun
    SF:\x202019\x2018:35:32\x20GMT\r\nConnection:\x20close\r\n\r\n<!doctype\x2
    SF:0html><html\x20lang=\"en\"><head><title>HTTP\x20Status\x20404\x20\xe2\x
    SF:80\x93\x20Not\x20Found</title><style\x20type=\"text/css\">h1\x20{font-f
    SF:amily:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font
    SF:-size:22px;}\x20h2\x20{font-family:Tahoma,Arial,sans-serif;color:white;
    SF:background-color:#525D76;font-size:16px;}\x20h3\x20{font-family:Tahoma,
    SF:Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;}\
    SF:x20body\x20{font-family:Tahoma,Arial,sans-serif;color:black;background-
    SF:color:white;}\x20b\x20{font-family:Tahoma,Arial,sans-serif;color:white;
    SF:background-color:#525D76;}\x20p\x20{font-family:Tahoma,Arial,sans-serif
    SF:;background:white;color:black;font-size:12px;}\x20a\x20{color:black;}\x
    SF:20a\.name\x20{color:black;}\x20\.line\x20{height:1px;background-color:#
    SF:525D76;border:none;}</style></head><body>");
    Service Info: OSs: Windows, Windows 98; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_98
    
SMB
----
Si nous tentons la connexion avec `SMBMAP`, nous avons accès à un système de fichier disponible en droit de lecture, la commande ci-dessous nous montre que nous avons accès.

    root@Seyptoo:~/htb/box/Arkham# smbmap.py -H 10.10.10.130 -u invaliduser
    [+] Finding open SMB ports....
    [+] Guest SMB session established on 10.10.10.130...
    [+] IP: 10.10.10.130:445        Name: 10.10.10.130                                      
            Disk                                                    Permissions
            ----                                                    -----------
            ADMIN$                                                  NO ACCESS
            BatShare                                                READ ONLY
            C$                                                      NO ACCESS
            IPC$                                                    READ ONLY
            Users                                                   READ ONLY
            
Tentons la connexion et de voir les informations sur le dossier `BatShare`, pour le connexion je vais utiliser `SMBCLIENT` pour télécharger les fichiers nécessaires.

    root@Seyptoo:~/htb/box/Arkham# smbclient \\\\10.10.10.130\\BatShare -U invaliduser -m SMB2
    WARNING: The "syslog" option is deprecated
    Enter invaliduser's password: 
    smb: \> ls
      .                                   D        0  Sun Feb  3 14:00:10 2019
      ..                                  D        0  Sun Feb  3 14:00:10 2019
      appserver.zip                       A  4046695  Fri Feb  1 07:13:37 2019

                    5158399 blocks of size 4096. 2005442 blocks available
    smb: \> mget appserver.zip
    Get file appserver.zip? y
    getting file \appserver.zip of size 4046695 as appserver.zip (1447,0 KiloBytes/sec) (average 1447,0 KiloBytes/sec)
    root@Seyptoo:~/htb/box/Arkham# unzip appserver.zip 
    Archive:  appserver.zip
      inflating: IMPORTANT.txt           
      inflating: backup.img              
    root@Seyptoo:~/htb/box/Arkham# ls
    appserver.zip  backup.img  IMPORTANT.txt

Nous avons extrait 2 fichiers, le fichier `backup.img` et `IMPORTANT.txt`, essayons de voir le fichier `backup.img` correspond à quelle type de fichier et ça fonctionnalité.

    root@Seyptoo:~/htb/box/Arkham# file backup.img 
    backup.img: LUKS encrypted file, ver 1 [aes, xts-plain64, sha256] UUID: d931ebb1-5edc-4453-8ab1-3d23bb85b38e
    
C'est un fichier `LUKS` qui est chiffré. `LUKS` (Linux Unified Key Setup) est le standard associé au noyau Linux pour le chiffrement de disque créé par Clemens Fruhwirth. D'après les informations on dois se connecter avec un mot de passe utilisons la commande `kpartx` pour monter ce système de fichier.

    root@Seyptoo:~/htb/box/Arkham# kpartx -a -v backup.img

Si nous regardons dans les dossiers, nous voyons que le système est monté mais protégé par un mot de passe. Je vous mets une photo juste ci-dessous.

[![forthebadge made-with-python](https://image.noelshack.com/fichiers/2019/25/5/1561119833-capture-du-2019-06-21-14-23-33.png)](https://image.noelshack.com/fichiers/2019/25/5/1561119833-capture-du-2019-06-21-14-23-33.png)

Nous avons le choix de cracker le mot de passe avec un programme spécifique ou bien d'utiliser la commande `binwalk` pour justement extraire des fichiers dans le système de fichier je vais vous montrez les deux méthodes.

Méthode 1
----
Pour la méthode numéro 1, nous allons cracker le système de fichier avec hashcat il y'a pas vraiment une grande complication, personnellement pour l'attaque bruteforce à pris environ 5 minutes. Pour la wordlist j'ai grandement simplifier la tâche car la boîte Arkham correspond justement à la série `batman`. Du coup j'ai créé ma wordlist en grepant batman dans `rockyou.txt`.

    root@Seyptoo:~/htb/box/Arkham# cat /usr/share/wordlist/rockyou.txt|grep batman > wd_list
    root@Seyptoo:~/htb/box/Arkham# hashcat -m 14600 -a 1 /dev/loop12 wd_list -o out.password
    root@Seyptoo:~/htb/box/Arkham# cat out.password
    password : batmanforever
  
[![forthebadge made-with-python](https://image.noelshack.com/fichiers/2019/25/5/1561124918-capture-du-2019-06-21-15-48-21.png)](https://image.noelshack.com/fichiers/2019/25/5/1561124918-capture-du-2019-06-21-15-48-21.png)
    
Méthode 2
----
Pour la méthode 2, nous allons utiliser le programme `binwalk` pour extraire les fichiers nécessaires, donc pour cette méthode c'est inutile d'avoir un mot de passe car nous allons extraire les fichiers avec `binwalk`.

    root@Seyptoo:~/htb/box/Arkham# binwalk -e backup.img                                                                                                   

    DECIMAL       HEXADECIMAL     DESCRIPTION
    --------------------------------------------------------------------------------
    8542755       0x825A23        Zip archive data, at least v1.0 to extract, name: Mask/tomcat-stuff/
    8542831       0x825A6F        Zip archive data, at least v2.0 to extract, compressed size: 1006, uncompressed size: 2208, name: Mask/tomcat-stuff/tomcat-users.xml
    8543929       0x825EB9        Zip archive data, at least v2.0 to extract, compressed size: 1151, uncompressed size: 3498, name: Mask/tomcat-stuff/web.xml.bak
    8545167       0x82638F        Zip archive data, at least v2.0 to extract, compressed size: 709, uncompressed size: 1368, name: Mask/tomcat-stuff/context.xml
    8545963       0x8266AB        Zip archive data, at least v2.0 to extract, compressed size: 621, uncompressed size: 1172, name: Mask/tomcat-stuff/jaspic-providers.xml
    8546680       0x826978        Zip archive data, at least v2.0 to extract, compressed size: 367, uncompressed size: 832, name: Mask/tomcat-stuff/faces-config.xml
    8547139       0x826B43        Zip archive data, at least v2.0 to extract, compressed size: 2599, uncompressed size: 7678, name: Mask/tomcat-stuff/server.xml
    8549824       0x8275C0        Zip archive data, at least v2.0 to extract, compressed size: 18347, uncompressed size: 174021, name: Mask/tomcat-stuff/web.xml
    8568254       0x82BDBE        Zip archive data, at least v1.0 to extract, compressed size: 39, uncompressed size: 39, name: Mask/tomcat-stuff/MANIFEST.MF
    8568380       0x82BE3C        Zip archive data, at least v2.0 to extract, compressed size: 7353, uncompressed size: 7586, name: Mask/robin.jpeg
    8575806       0x82DB3E        Zip archive data, at least v2.0 to extract, compressed size: 105045, uncompressed size: 105374, name: Mask/me.jpg
    8680920       0x8475D8        Zip archive data, at least v2.0 to extract, compressed size: 687109, uncompressed size: 687160, name: Mask/mycar.jpg

Les fichiers ont été extrait avec succès, donc si vous regardez dans le dossier créé par `binwalk` vous verrez que les données sont bien présent dans le dossier.

    root@Seyptoo:~/htb/box/Arkham# cd _backup.img.extracted/
    root@Seyptoo:~/htb/box/Arkham/_backup.img.extracted# cd Mask
    root@Seyptoo:~/htb/box/Arkham/_backup.img.extracted/Mask# ls
    me.jpg  mycar.jpg  robin.jpeg  tomcat-stuff

HTTP - 8080
----
Pour cette partie nous avons des informations, vous verrez que dans le fichier `web.xml.bak` ce fichier sera la clé pour faire notre reverse shell dans ce système. Donc sur le port 8080 il y'a un chemin plutôt intéréssant, dans le chemin `userSubscribe.faces`. Si vous regardez bien dans le code source de la page il y'a un `ViewState` et cette partie sera vulnérable à l'attaque `Java Deserialisation`. Nous allons essayer de déchiffrer `ViewState` avec un script Python.
 
Revenons sur notre fichier `web.xml.bak`, dans ce fichier XML il y'a des informations très interéssant, il y'a le type d'algorithme utilisé et également le secret pour justement déchiffrer `ViewState` et également ensuite chiffrer notre payload.

[![forthebadge made-with-python](https://image.noelshack.com/fichiers/2019/25/5/1561127390-capture-du-2019-06-21-16-29-39.png)](https://image.noelshack.com/fichiers/2019/25/5/1561127390-capture-du-2019-06-21-16-29-39.png)

SECRET     : [SnNGOTg3Ni0=] en texte : "JsF9876-". <br />
ALGORITHME : [HmacSHA1].

Le script Python pour déchiffrer `ViewState` : 

    from Crypto.Cipher import DES
    import base64
    from hashlib import sha1
    import hmac

    def pad(s):
            return s + (block_size - len(s) % block_size) * chr(block_size - len(s) % block_size)

    block_size = DES.block_size
    key = "JsF9876-"

    viewstate = "wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE="
    viewstate = base64.b64decode(viewstate)
    obj = DES.new(key, DES.MODE_ECB)
    decrypted_viewstate = obj.decrypt(pad(viewstate))
    print(decrypted_viewstate)

Donc si tout ce passe très bien, vous aurez le lien ou plus précisement le chemin `userSubscribe.faces` lors du déchiffrement de `ViewState`.

